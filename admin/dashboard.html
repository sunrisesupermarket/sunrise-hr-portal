<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Sunrise</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#1e293b">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/footer.css">
    <style>
        :root {
            --admin-dark: #1e293b;
            --admin-accent: #3b82f6;
            --white: #ffffff;
            --bg-light: #f1f5f9;
        }

        body {
            font-family: 'Outfit', sans-serif;
            margin: 0;
            background-color: var(--bg-light);
            color: #333;
        }

        .header {
            background-color: var(--admin-dark);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-weight: 700;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .btn-export {
            background-color: #10b981;
            color: white;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Table Styles */
        .card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 1rem;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 0.75rem 1rem;
                flex-direction: column;
                gap: 0.5rem;
            }

            .logo {
                font-size: 1rem;
            }

            .container {
                margin: 1rem auto;
                padding: 0 0.5rem;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .btn-export {
                width: 100%;
                justify-content: center;
            }

            .card {
                padding: 0.5rem;
            }

            table {
                font-size: 0.85rem;
                display: block;
                overflow-x: auto;
            }

            th,
            td {
                padding: 0.75rem 0.5rem;
            }

            .avatar {
                width: 30px;
                height: 30px;
            }

            input,
            button {
                font-size: 16px;
                /* Prevents zoom on iOS */
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 0.5rem;
            }

            h2 {
                font-size: 1.25rem;
            }

            .card {
                padding: 0.25rem;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="logo">
            <span>üõ°Ô∏è Sunrise Admin Panel</span>
        </div>
        <div>
            <span id="userEmail" style="margin-right: 15px; opacity: 0.8; font-size: 0.9rem;"></span>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="toolbar">
            <h2>Staff Records (Read Only)</h2>
            <a href="/api/admin/export-excel" class="btn-export">üìä Download Excel Report</a>
        </div>

        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>Action</th>
                        <th>Photo</th>
                        <th>Name</th>
                        <th>Designation</th>
                        <th>Location</th>
                        <th>Joined</th>
                        <th>Status</th>
                        <th>Hiring Officer</th>
                    </tr>
                </thead>
                <tbody id="staffTableBody">
                    <tr>
                        <td colspan="8">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <footer class="footer">
        ¬© 2026 Sunrise HR Portal. Developed by <a href="https://www.edameyo.it.com" target="_blank"
            rel="noopener noreferrer">√©d√°m√®yO</a>
    </footer>

    <!-- MODAL: IMAGE VIEWER -->
    <div id="imageViewerModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 100;"
        onclick="if(event.target.id==='imageViewerModal') this.style.display='none'">
        <div style="background: transparent; text-align: center; pointer-events: none;">
            <div style="pointer-events: auto; display: inline-block;">
                <img id="fullSizeImage" src=""
                    style="max-height: 80vh; max-width: 100%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); background: white;">
                <div style="margin-top: 15px;">
                    <a id="downloadImageBtn" href="#" download="staff_image"
                        style="background: #10b981; color: white; padding: 10px 20px; text-decoration: none; border-radius: 6px; display: inline-block; margin-right: 10px;">Download
                        Original</a>
                    <button
                        style="background: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;"
                        onclick="document.getElementById('imageViewerModal').style.display='none'">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        let supabase;

        async function init() {
            const res = await fetch('/api/config');
            const { supabaseUrl, supabaseKey } = await res.json();
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            // Auth Check
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'index.html';
                return;
            }

            // ENFORCE ADMIN ROLE (Email must contain 'admin')
            if (!session.user.email.includes('admin')) {
                alert('Access Denied. You are logged in with an HR account. Please log in with an Admin account.');
                await supabase.auth.signOut();
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('userEmail').textContent = session.user.email;
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await supabase.auth.signOut();
                window.location.href = 'index.html';
            });

            // Initial Load
            loadStaffList();
            setupRealtime();
        }

        async function loadStaffList() {
            const tbody = document.getElementById('staffTableBody');
            tbody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';

            const { data, error } = await supabase
                .from('staff_records')
                .select('*')
                .order('created_at', { ascending: false });

            if (data && data.length > 0) {
                tbody.innerHTML = data.map(staff => `
                    <tr>
                        <td>
                            <button
                                class="btn-delete"
                                data-id="${staff.id}"
                                data-name="${String(staff.full_name).replace(/"/g, '&quot;')}"
                                style="background:#ef4444;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer"
                                title="Delete this staff">
                                Delete
                            </button>
                        </td>
                        <td>
                             <img src="${staff.picture_url}" class="avatar" onclick="openImageModal('${staff.picture_url}')" style="cursor: pointer;" title="View Full">
                        </td>
                        <td>${staff.full_name}</td>
                        <td>${staff.designation}</td>
                        <td>${staff.location}</td>
                        <td>${staff.resumption_date || '-'}</td>
                        <td>${staff.exit_date ? '<span style="color:red">Exited</span>' : 'Active'}</td>
                        <td>${staff.hiring_officer}</td>
                    </tr>
                `).join('');
                setupDeleteButtons();
            } else {
                tbody.innerHTML = '<tr><td colspan="7">No records found.</td></tr>';
            }
        }

        function setupRealtime() {
            supabase.channel('staff_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'staff_records' }, () => { loadStaffList(); })
                .subscribe();
        }

        function setupDeleteButtons() {
            const buttons = document.querySelectorAll('.btn-delete');
            buttons.forEach(btn => {
                const id = Number(btn.getAttribute('data-id'));
                const name = btn.getAttribute('data-name');
                btn.addEventListener('click', () => deleteStaff(id, name));
            });
        }

        window.deleteStaff = async (id, name) => {
            try {
                const ok = confirm(`Delete staff: ${name}? This action cannot be undone.`);
                if (!ok) return;

                const { data: record, error: fetchErr } = await supabase
                    .from('staff_records')
                    .select('id,picture_url')
                    .eq('id', id)
                    .single();
                if (fetchErr) {
                    alert('Failed to fetch staff: ' + fetchErr.message);
                    return;
                }

                if (record && record.picture_url) {
                    try {
                        const parsed = (() => {
                            try {
                                const u = new URL(record.picture_url);
                                const parts = u.pathname.split('/').filter(Boolean);
                                const idx = parts.indexOf('public');
                                if (idx !== -1 && parts[idx + 1]) {
                                    const bucket = parts[idx + 1];
                                    const path = parts.slice(idx + 2).join('/');
                                    if (bucket && path) return { bucket, path };
                                }
                                return null;
                            } catch {
                                return null;
                            }
                        })();
                        if (parsed) {
                            await supabase.storage.from(parsed.bucket).remove([parsed.path]);
                        }
                    } catch (storageErr) {
                        alert('Warning: could not remove photo from storage: ' + storageErr.message);
                    }
                }

                const { error } = await supabase
                    .from('staff_records')
                    .delete()
                    .eq('id', id);
                if (error) {
                    alert('Delete failed: ' + error.message);
                    return;
                }
                loadStaffList();
            } catch (err) {
                alert('Unexpected error: ' + err.message);
            }
        };

        window.openImageModal = (url) => {
            const modal = document.getElementById('imageViewerModal');
            const img = document.getElementById('fullSizeImage');
            const downloadBtn = document.getElementById('downloadImageBtn');

            img.src = url;
            downloadBtn.href = url;
            modal.style.display = 'flex';
        };

        init();
    </script>
</body>

</html>
